<!DOCTYPE html>
<html>

<head>
	<meta charset='UTF-8'>
	
	<title>Moneyball Table</title>
	
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!--[if !IE]><!-->
	<style scoped>
	* { 
	margin: 0; 
	padding: 0; 
	}
	body { 
	font: 14px/1.4 Georgia, Serif; 
	}
	#page-wrap {
	margin: 50px;
	}
	p {
	margin: 20px 0; 
	}

	/* 
	Generic Styling, for Desktops/Laptops 
	*/
	table { 
		width: 100%; 
		max-width: 400px;
		border-collapse: collapse; 
	}
	/* Zebra striping */

	tr:nth-of-type(odd) { 
		background: #eee; 
	}
	th { 
		background: #333; 
		color: white; 
		font-weight: bold; 
		cursor: s-resize;
		background-repeat: no-repeat;
		background-position: 3% center;
	}
	td, th { 
		padding: 6px; 
		border: 1px solid #ccc; 
		text-align: left; 
	}
	
	th.des:after {
	content: " \21D3";
	}
	
	th.aes:after {
	content: " \21D1";
	}

	.multiselect-container>li>a>label {
		padding: 4px 20px 3px 20px;
	}

	</style>
	<!--<![endif]-->

</head>

<body>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
		
	<!-- Build your select: -->
	<div>
		<span>Select States</span>
		<select id="example-getting-started" multiple="multiple">
			<option value="TX">Texas</option>
			<option value="KS">Kansas</option>
			<option value="MI">Michigan</option>
			<option value="GA">Georgia</option>
		</select>
		<label>
			<input id = "normcheckbx" type="checkbox" checked/>
			<span id = "normcheck">Normalize to Selected Region</span>
		</label>
	</div>
	<div>
		<span id = "normperc"></span>
	</div>
	

	<table id="money-table"></table>

	<!-- Initialize the plugin: -->
	<script type="text/javascript">
		$(document).ready(function() {
			$('#example-getting-started').multiselect(
				{
				allSelectedText: 'All',
				maxHeight: 300,
				includeSelectAllOption: true,
				selectAll: true
			})
			$('#example-getting-started').multiselect('selectAll', false);
			$('#example-getting-started').multiselect('updateButtonText');

			
			$('#example-getting-started').change(function() {
				console.log($(this).val());
				d3.selectAll('tr').remove();
				buildTable(20,3);
			}); 

			$('#normcheckbx').change(function() {
				console.log($(this).is(':checked'));
				d3.selectAll('tr').remove();
				buildTable(20,3);
			}); 
		});
	</script>

	<!-- TODOS ******************* -->
	<!-- 1. table length regulate (i.e. top N and n per state)-->
	<!-- 2. Normalize voter power each build (also show % relative to national)-->


	<script type="text/javascript" src="https://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript">

		function buildTable(Total, Per){
			d3.csv("TX_voter_power_estimates_3.csv", function(error, data) {
				if (error) throw error;



				console.log($('#example-getting-started').val());

				data.forEach(function(d) {
					d['NORMALIZED'] = +d['NORMALIZED'];
					d['MARGIN'] = +d['MARGIN'];
					d['VOTER_POWER'] = +d['VOTER_POWER'];
					
					});

				console.log(data);

				console.log(data.filter(filterData))

				for (d in data) {
					if (data[d]['favored'] == 'FALSE') {
						data[d]['lean'] = data[d]['confidence']
					}
					else {
						data[d]['lean'] = data[d]['confidence'] + " " + data[d]['favored']
					}
				}
					
				data.sort(function(a, b) { return b['NORMALIZED'] > a['NORMALIZED']; });
				filtered_data = data.filter(filterData).slice(0,Total)
				
				var sortAscending = true;
				var table = d3.select('#money-table').append('table');
				// var titles = ['state', 'district', 'lean', 'MARGIN', 'VOTER_POWER','NORMALIZED']
				var titles = ['district', 'lean', 'NORMALIZED']
				var display_titles = titles
				var headers = table.append('thead').append('tr')
								.selectAll('th')
								.data(display_titles).enter()
								.append('th')
								.text(function (d) {
										return d;
									})
								.on('click', function (d) {
									headers.attr('class', 'header');
									
									if (sortAscending) {
										rows.sort(function(a, b) { return b[d] < a[d]; });
										sortAscending = false;
										this.className = 'aes';
									} else {
										rows.sort(function(a, b) { return b[d] > a[d]; });
										sortAscending = true;
										this.className = 'des';
									}
									
								});
				
				var rows = table.append('tbody').selectAll('tr')
							.data(filtered_data ).enter()
							.append('tr');
				rows.selectAll('td')
					.data(function (d) {
						return titles.map(function (k) {
							return { 'value': d[k], 'name': k};
						});
					}).enter()
					.append('td')
					.attr('data-th', function (d) {
						return d.name;
					})
					.text(function (d) {
						return d.value;
					});

				rows.sort(function(a, b) { return b['NORMALIZED'] > a['NORMALIZED']; });

				console.log(d3.selectAll("[data-th=NORMALIZED]"))

				d3.selectAll("[data-th=NORMALIZED]").
					text(function (d) {
						return (d.value / Math.max.apply(Math, extractColumn(
							$('#normcheckbx').is(':checked')  ? filtered_data : data, 
							"NORMALIZED")) * 100).toFixed(1);
					});
				var local_max = Math.max.apply(Math, extractColumn(filtered_data, "NORMALIZED"))
				var global_max = Math.max.apply(Math, extractColumn(data, "NORMALIZED"))
				if (local_max < global_max) {
						d3.select("#normperc").text("*Normalized to " + (local_max/global_max * 100).toFixed(1) + "% of highest nationwide voter power")
						console.log("****updated")
					}

				//normalizeColumn(rows, null)
			});
		}

		function filterData(entry) {
		
			states = $('#example-getting-started').val()

			if (states.indexOf(entry.state) !== -1) {
				return true
			}
				return false
		}

		function extractColumn(arr, column) {
  			return arr.map(x => x[column])
		}

		function normalizeColumn(rows, column) {
			for (row in rows) {
				console.log(row)

			}

		}
		

		buildTable(20,3);
	
	</script>

</body>

</html>